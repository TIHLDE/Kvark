import { Box, List, ListItem, ListItemAvatar, ListItemButton, ListItemText, Stack, Typography } from '@mui/material';
import { parseISO } from 'date-fns';
import { useMemo } from 'react';
import { Link, useParams } from 'react-router-dom';
import URLS from 'URLS';
import { formatDate } from 'utils';

import { useBadge, useBadgeCategory, useBadgeLeaderboard } from 'hooks/Badge';

import BadgeCategoryItem from 'pages/Badges/components/BadgeCategoryItem';

import Pagination from 'components/layout/Pagination';
import Paper from 'components/layout/Paper';
import NotFoundIndicator from 'components/miscellaneous/NotFoundIndicator';
import { Avatar, AvatarFallback, AvatarImage } from 'components/ui/avatar';

const BadgeDetails = () => {
  const { badgeId } = useParams<'badgeId'>();
  const { data: badge } = useBadge(badgeId || '_');
  const { data: badgeCategory } = useBadgeCategory(badge?.badge_category || '_', { enabled: Boolean(badge?.badge_category) });
  const { data, error, hasNextPage, fetchNextPage, isLoading, isFetching } = useBadgeLeaderboard(badgeId || '_');
  const leaderboardEntries = useMemo(() => (data ? data.pages.map((page) => page.results).flat() : []), [data]);

  return (
    <div className='px-2 mx-auto mt-40 max-w-5xl w-full'>
      <Paper sx={{ margin: '-60px auto 60px', position: 'relative' }}>
        {badge && (
          <Stack direction='row' gap={1} sx={{ mb: 1, alignItems: 'center', flex: 1 }}>
            <Box
              alt={badge?.title}
              component='img'
              loading='lazy'
              src={badge?.image || ''}
              sx={{ objectFit: 'contain', px: 1, height: { xs: 55, md: 70 }, width: { xs: 55, md: 70 } }}
            />
            <Stack>
              <Typography component='h1' variant='h2'>
                {badge.title}
              </Typography>
              <Typography sx={{ fontSize: '0.7rem', fontStyle: 'italic', fontWeight: 'bold', mt: 0.5 }} variant='subtitle2'>
                Ervervet av{' '}
                <Box component='span' sx={{ color: (theme) => theme.palette.error.main }}>
                  {badge.total_completion_percentage.toFixed(1)}%
                </Box>
              </Typography>
            </Stack>
          </Stack>
        )}
        <Typography variant='body2'>{badge?.description}</Typography>
        {badgeCategory && (
          <>
            <Typography sx={{ mt: 1, mb: 0.5, fontWeight: 'bold' }} variant='body2'>{`Del av "${badgeCategory.name}":`}</Typography>
            <BadgeCategoryItem badgeCategory={badgeCategory} />
          </>
        )}
        <Typography sx={{ mt: 1 }} variant='h3'>
          Ervervet av:
        </Typography>
        {!isLoading && !leaderboardEntries.length && <NotFoundIndicator header='Ingen har mottatt dette badget enda' />}
        {error && <Paper>{error.detail}</Paper>}
        {data !== undefined && (
          <Pagination fullWidth hasNextPage={hasNextPage} isLoading={isFetching} nextPage={() => fetchNextPage()}>
            <Stack component={List} gap={1}>
              {leaderboardEntries.map((entry) => (
                <ListItem component={Paper} disablePadding key={entry.user.user_id} noOverflow noPadding>
                  <ListItemButton component={Link} to={`${URLS.profile}${entry.user.user_id}/`}>
                    <ListItemAvatar>
                      <Avatar>
                        <AvatarImage alt={entry.user.first_name} src={entry.user.image} />
                        <AvatarFallback>{entry.user.first_name[0] + entry.user.last_name[0]}</AvatarFallback>
                      </Avatar>
                    </ListItemAvatar>
                    <ListItemText
                      primary={`${entry.user.first_name} ${entry.user.last_name}`}
                      secondary={`Mottatt: ${formatDate(parseISO(entry.created_at))}`}
                    />
                  </ListItemButton>
                </ListItem>
              ))}
            </Stack>
          </Pagination>
        )}
      </Paper>
    </div>
  );
};

export default BadgeDetails;
